<!DOCTYPE html>
<html>
<head>
    <title>ForkFork - Add Friend (External)</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Smart App Banner for better iOS app detection -->
    <meta name="apple-itunes-app" content="app-id=6744844399">
    
    <!-- Prevent caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <script>
        // ì„¸ì…˜ ê´€ë¦¬ ë° ë¬´í•œ ë£¨í”„ ë°©ì§€ (ë©”ì¸ í˜ì´ì§€ì™€ ë™ì¼)
        const SESSION_KEY = 'forkfork_external_launch_attempt';
        const MAX_ATTEMPTS = 2;
        const ATTEMPT_COOLDOWN = 10000; // 10ì´ˆ
        
        // ì‹œë„ íšŸìˆ˜ í™•ì¸ ë° ê´€ë¦¬
        function canAttemptAppLaunch() {
            const now = Date.now();
            const sessionData = sessionStorage.getItem(SESSION_KEY);
            
            if (!sessionData) {
                sessionStorage.setItem(SESSION_KEY, JSON.stringify({
                    attempts: 1,
                    lastAttempt: now
                }));
                return true;
            }
            
            try {
                const data = JSON.parse(sessionData);
                const timeSinceLastAttempt = now - data.lastAttempt;
                
                if (timeSinceLastAttempt > ATTEMPT_COOLDOWN) {
                    sessionStorage.setItem(SESSION_KEY, JSON.stringify({
                        attempts: 1,
                        lastAttempt: now
                    }));
                    return true;
                }
                
                if (data.attempts >= MAX_ATTEMPTS) {
                    console.log('ì™¸ë¶€ ë¸Œë¼ìš°ì € - ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ë„ë‹¬');
                    return false;
                }
                
                sessionStorage.setItem(SESSION_KEY, JSON.stringify({
                    attempts: data.attempts + 1,
                    lastAttempt: now
                }));
                return true;
                
            } catch (error) {
                console.error('ì„¸ì…˜ ë°ì´í„° ì—ëŸ¬:', error);
                sessionStorage.removeItem(SESSION_KEY);
                return true;
            }
        }
        
        // ì•± ì‹¤í–‰ ì„±ê³µ ê¸°ë¡
        function markAppLaunchSuccess() {
            sessionStorage.setItem(SESSION_KEY, JSON.stringify({
                attempts: 0,
                lastAttempt: Date.now(),
                success: true
            }));
        }
        
        // ì™¸ë¶€ ë¸Œë¼ìš°ì €ì—ì„œì˜ ì•± ì‹¤í–‰ ì²˜ë¦¬
        function handleExternalBrowser() {
            const urlParams = new URLSearchParams(window.location.search);
            const deviceID = urlParams.get('deviceID');
            
            if (!deviceID) {
                window.location.href = "https://apps.apple.com/kr/app/forkfork/id6744844399?l=en-GB";
                return;
            }
            
            console.log('ì™¸ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤í–‰ë¨ - deviceID:', deviceID);
            
            // ì´ë¯¸ ì„±ê³µí–ˆëŠ”ì§€ í™•ì¸
            const sessionData = sessionStorage.getItem(SESSION_KEY);
            if (sessionData) {
                try {
                    const data = JSON.parse(sessionData);
                    if (data.success) {
                        console.log('ì´ë¯¸ ì•± ì‹¤í–‰ì— ì„±ê³µí–ˆìŒ');
                        showSuccessMessage();
                        return;
                    }
                } catch (error) {
                    console.error('ì„¸ì…˜ í™•ì¸ ì—ëŸ¬:', error);
                }
            }
            
            // ì‹œë„ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
            if (!canAttemptAppLaunch()) {
                console.log('ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ - ì•±ìŠ¤í† ì–´ë¡œ ì´ë™');
                redirectToAppStore();
                return;
            }
            
            let hasRedirected = false;
            
            // í˜ì´ì§€ ê°€ì‹œì„± ë³€í™” ê°ì§€
            const visibilityHandler = () => {
                if (document.hidden && !hasRedirected) {
                    hasRedirected = true;
                    markAppLaunchSuccess();
                    console.log('ì•± ì‹¤í–‰ ì„±ê³µìœ¼ë¡œ ì¶”ì •');
                    document.removeEventListener('visibilitychange', visibilityHandler);
                }
            };
            
            document.addEventListener('visibilitychange', visibilityHandler);
            
            // ì•± ì‹¤í–‰ ì‹œë„
            try {
                // ì»¤ìŠ¤í…€ URL ìŠ¤í‚´ë§Œ ì‚¬ìš© (ë” ì•ˆì „)
                console.log('ì»¤ìŠ¤í…€ URL ìŠ¤í‚´ìœ¼ë¡œ ì•± ì‹¤í–‰ ì‹œë„');
                window.location.href = `forkfork://addfriend?deviceID=${deviceID}`;
                
                // ì§§ì€ ì§€ì—° í›„ ì‹¤íŒ¨ ê°ì§€
                setTimeout(() => {
                    if (!document.hidden && !hasRedirected) {
                        console.log('ì•± ì‹¤í–‰ ì‹¤íŒ¨ë¡œ ì¶”ì •');
                    }
                }, 1000);
                
            } catch (error) {
                console.error('ì•± ì‹¤í–‰ ì‹œë„ ì—ëŸ¬:', error);
            }
            
            // íƒ€ì´ë¨¸ ì„¤ì • (ì•±ìŠ¤í† ì–´ë¡œ ì´ë™)
            setTimeout(() => {
                if (!hasRedirected) {
                    hasRedirected = true;
                    document.removeEventListener('visibilitychange', visibilityHandler);
                    console.log('ì•± ì‹¤í–‰ ì‹¤íŒ¨ - ì•±ìŠ¤í† ì–´ë¡œ ì´ë™');
                    redirectToAppStore();
                }
            }, 2500); // 2.5ì´ˆë¡œ ì„¤ì •
        }
        
        function redirectToAppStore() {
            window.location.href = "https://apps.apple.com/kr/app/forkfork/id6744844399?l=en-GB";
        }
        
        function showSuccessMessage() {
            const loadingDiv = document.querySelector('.loading-content');
            if (loadingDiv) {
                loadingDiv.innerHTML = `
                    <h1>ğŸ´ ForkFork</h1>
                    <p>âœ… ì•± ì‹¤í–‰ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</p>
                    <p style="font-size: 14px; color: #666;">ì´ í˜ì´ì§€ë¥¼ ë‹«ìœ¼ì…”ë„ ë©ë‹ˆë‹¤.</p>
                `;
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.onload = handleExternalBrowser;
        
        // í˜ì´ì§€ ì–¸ë¡œë“œ ë°©ì§€
        window.addEventListener('beforeunload', function(e) {
            console.log('ì™¸ë¶€ í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œë„');
        });
    </script>
</head>
<body>
    <div class="loading-content" style="text-align: center; padding: 50px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
        <h1>ğŸ´ ForkFork</h1>
        <p>ì•±ì„ ì‹¤í–‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
        <div style="margin: 20px 0;">
            <div style="width: 50px; height: 50px; border: 3px solid #f3f3f3; border-top: 3px solid #007AFF; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        </div>
        <p style="font-size: 14px; color: #666;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
        
        <div style="margin-top: 30px; font-size: 12px; color: #999;">
            <p>ì•±ì´ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ì§€ ì•ŠëŠ”ë‹¤ë©´:</p>
            <a href="https://apps.apple.com/kr/app/forkfork/id6744844399?l=en-GB" 
               style="color: #007AFF; text-decoration: none;">
                â†’ App Storeì—ì„œ ë‹¤ìš´ë¡œë“œ â†
            </a>
        </div>
    </div>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html> 