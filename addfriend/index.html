<!DOCTYPE html>
<html>
<head>
    <title>ForkFork - Add Friend</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Smart App Banner for better iOS app detection -->
    <meta name="apple-itunes-app" content="app-id=6744844399">
    
    <!-- Prevent caching to ensure fresh content -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- Open Graph tags for better sharing -->
    <meta property="og:title" content="ForkFork - ì¹œêµ¬ ì¶”ê°€">
    <meta property="og:description" content="ForkFork ì•±ì—ì„œ ìƒˆë¡œìš´ ì¹œêµ¬ë¥¼ ì¶”ê°€í•˜ì„¸ìš”!">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://forkfork-official.github.io/addfriend">
    
    <!-- Additional iOS compatibility -->
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <script>
        // ì„¸ì…˜ ê´€ë¦¬ ë° ë¬´í•œ ë£¨í”„ ë°©ì§€
        const SESSION_KEY = 'forkfork_app_launch_attempt';
        const MAX_ATTEMPTS = 2; // ìµœëŒ€ ì‹œë„ íšŸìˆ˜
        const ATTEMPT_COOLDOWN = 10000; // 10ì´ˆ ì¿¨ë‹¤ìš´
        
        // ì¹´ì¹´ì˜¤í†¡ ì¸ì•± ë¸Œë¼ìš°ì € ê°ì§€
        function isKakaoTalkInApp() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            return userAgent.toLowerCase().includes('kakaotalk');
        }
        
        // ì‹œë„ íšŸìˆ˜ í™•ì¸ ë° ê´€ë¦¬
        function canAttemptAppLaunch() {
            const now = Date.now();
            const sessionData = sessionStorage.getItem(SESSION_KEY);
            
            if (!sessionData) {
                // ì²« ì‹œë„
                sessionStorage.setItem(SESSION_KEY, JSON.stringify({
                    attempts: 1,
                    lastAttempt: now
                }));
                return true;
            }
            
            try {
                const data = JSON.parse(sessionData);
                const timeSinceLastAttempt = now - data.lastAttempt;
                
                // ì¿¨ë‹¤ìš´ ì‹œê°„ì´ ì§€ë‚¬ìœ¼ë©´ ë¦¬ì…‹
                if (timeSinceLastAttempt > ATTEMPT_COOLDOWN) {
                    sessionStorage.setItem(SESSION_KEY, JSON.stringify({
                        attempts: 1,
                        lastAttempt: now
                    }));
                    return true;
                }
                
                // ìµœëŒ€ ì‹œë„ íšŸìˆ˜ í™•ì¸
                if (data.attempts >= MAX_ATTEMPTS) {
                    console.log('ìµœëŒ€ ì•± ì‹¤í–‰ ì‹œë„ íšŸìˆ˜ì— ë„ë‹¬í•¨');
                    return false;
                }
                
                // ì‹œë„ íšŸìˆ˜ ì¦ê°€
                sessionStorage.setItem(SESSION_KEY, JSON.stringify({
                    attempts: data.attempts + 1,
                    lastAttempt: now
                }));
                return true;
                
            } catch (error) {
                console.error('ì„¸ì…˜ ë°ì´í„° íŒŒì‹± ì—ëŸ¬:', error);
                sessionStorage.removeItem(SESSION_KEY);
                return true;
            }
        }
        
        // ì•± ì‹¤í–‰ ì„±ê³µ ê¸°ë¡
        function markAppLaunchSuccess() {
            sessionStorage.setItem(SESSION_KEY, JSON.stringify({
                attempts: 0,
                lastAttempt: Date.now(),
                success: true
            }));
        }
        
        // ì•± ì‹¤í–‰ ì„±ê³µ ê¸°ë¡
        function attemptAppLaunch(deviceID) {
            return new Promise((resolve, reject) => {
                if (!canAttemptAppLaunch()) {
                    reject(new Error('Too many attempts'));
                    return;
                }
                
                console.log('ì•± ì‹¤í–‰ ì‹œë„ ì¤‘...');
                let hasRedirected = false;
                let visibilityHandler;
                
                // íƒ€ì´ë¨¸ ì„¤ì • (ë” ì§§ì€ ì‹œê°„)
                const timeout = setTimeout(() => {
                    if (!hasRedirected) {
                        hasRedirected = true;
                        cleanup();
                        reject(new Error('App launch timeout'));
                    }
                }, 1500); // 1.5ì´ˆë¡œ ë‹¨ì¶•
                
                // ì •ë¦¬ í•¨ìˆ˜
                const cleanup = () => {
                    clearTimeout(timeout);
                    if (visibilityHandler) {
                        document.removeEventListener('visibilitychange', visibilityHandler);
                    }
                };
                
                // í˜ì´ì§€ ê°€ì‹œì„± ë³€í™” ê°ì§€
                visibilityHandler = () => {
                    if (document.hidden && !hasRedirected) {
                        hasRedirected = true;
                        markAppLaunchSuccess();
                        cleanup();
                        resolve();
                    }
                };
                
                document.addEventListener('visibilitychange', visibilityHandler);
                
                // ì•± ì‹¤í–‰ ì‹œë„ (ë” ì•ˆì „í•œ ë°©ë²•)
                try {
                    // ì»¤ìŠ¤í…€ URL ìŠ¤í‚´ë§Œ ì‚¬ìš© (iframe ì—†ì´)
                    const startTime = Date.now();
                    window.location.href = `forkfork://addfriend?deviceID=${deviceID}`;
                    
                    // ì§§ì€ ì‹œê°„ í›„ ì²´í¬
                    setTimeout(() => {
                        const timeElapsed = Date.now() - startTime;
                        // ë§Œì•½ í˜ì´ì§€ê°€ ì—¬ì „íˆ í™œì„±í™”ë˜ì–´ ìˆê³  ì‹œê°„ì´ ë³„ë¡œ ì•ˆ ì§€ë‚¬ë‹¤ë©´ ì‹¤íŒ¨ë¡œ ê°„ì£¼
                        if (!document.hidden && timeElapsed < 1000 && !hasRedirected) {
                            console.log('ì»¤ìŠ¤í…€ URL ìŠ¤í‚´ ì‹¤íŒ¨ë¡œ ì¶”ì •');
                        }
                    }, 500);
                    
                } catch (error) {
                    cleanup();
                    reject(error);
                }
            });
        }
        
        // ë©”ì¸ ì²˜ë¦¬ í•¨ìˆ˜
        function handleAppRedirect() {
            // Get deviceID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const deviceID = urlParams.get('deviceID');
            
            if (!deviceID) {
                // No deviceID, redirect to App Store
                window.location.href = "https://apps.apple.com/kr/app/forkfork/id6744844399?l=en-GB";
                return;
            }
            
            // ì´ë¯¸ ì„±ê³µí–ˆëŠ”ì§€ í™•ì¸
            const sessionData = sessionStorage.getItem(SESSION_KEY);
            if (sessionData) {
                try {
                    const data = JSON.parse(sessionData);
                    if (data.success) {
                        console.log('ì´ë¯¸ ì•± ì‹¤í–‰ì— ì„±ê³µí–ˆìŒ');
                        return;
                    }
                } catch (error) {
                    console.error('ì„¸ì…˜ ë°ì´í„° í™•ì¸ ì—ëŸ¬:', error);
                }
            }
            
            // ì¹´ì¹´ì˜¤í†¡ ì¸ì•± ë¸Œë¼ìš°ì €ì¸ì§€ í™•ì¸
            if (isKakaoTalkInApp()) {
                console.log('ì¹´ì¹´ì˜¤í†¡ ì¸ì•± ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤í–‰ë¨');
                
                // ì¹´ì¹´ì˜¤í†¡ì—ì„œëŠ” ì•± ì‹¤í–‰ ì‹œë„ í›„ ì‹¤íŒ¨ ì‹œ ì•ˆë‚´
                attemptAppLaunch(deviceID)
                    .then(() => {
                        console.log('ì•± ì‹¤í–‰ ì„±ê³µ');
                    })
                    .catch((error) => {
                        console.log('ì•± ì‹¤í–‰ ì‹¤íŒ¨:', error.message);
                        if (error.message === 'Too many attempts') {
                            showKakaoInstructions(deviceID);
                        } else {
                            // ì²« ë²ˆì§¸ ì‹¤íŒ¨ ì‹œì—ë§Œ ì¬ì‹œë„ ì•ˆë‚´
                            const sessionData = sessionStorage.getItem(SESSION_KEY);
                            if (sessionData) {
                                const data = JSON.parse(sessionData);
                                if (data.attempts === 1) {
                                    setTimeout(() => showKakaoInstructions(deviceID), 1000);
                                } else {
                                    showKakaoInstructions(deviceID);
                                }
                            }
                        }
                    });
                
                return;
            }
            
            // ì¼ë°˜ ë¸Œë¼ìš°ì €ì—ì„œì˜ ì²˜ë¦¬
            attemptAppLaunch(deviceID)
                .then(() => {
                    console.log('ì•± ì‹¤í–‰ ì„±ê³µ');
                })
                .catch((error) => {
                    console.log('ì•± ì‹¤í–‰ ì‹¤íŒ¨:', error.message);
                    if (error.message !== 'Too many attempts') {
                        // ì•± ì‹¤í–‰ ì‹¤íŒ¨ ì‹œ ì•±ìŠ¤í† ì–´ë¡œ ì´ë™
                        window.location.href = "https://apps.apple.com/kr/app/forkfork/id6744844399?l=en-GB";
                    }
                });
        }
        
        // ì¹´ì¹´ì˜¤í†¡ ì‚¬ìš©ìë¥¼ ìœ„í•œ ì•ˆë‚´ í‘œì‹œ
        function showKakaoInstructions(deviceID) {
            // ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            const loadingMsg = document.querySelector('.loading-message');
            if (loadingMsg) {
                loadingMsg.style.display = 'none';
            }
            
            const instructionDiv = document.getElementById('kakao-instructions');
            if (instructionDiv) {
                instructionDiv.style.display = 'block';
                
                // URL ë³µì‚¬ ê¸°ëŠ¥
                const copyButton = document.getElementById('copy-url-btn');
                if (copyButton) {
                    copyButton.onclick = () => {
                        const urlToCopy = `https://forkfork-official.github.io/addfriend?deviceID=${deviceID}`;
                        
                        // Clipboard API ì‚¬ìš©
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            navigator.clipboard.writeText(urlToCopy).then(() => {
                                alert('URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. Safarië‚˜ Chromeì—ì„œ ë¶™ì—¬ë„£ê¸°í•˜ì—¬ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                            }).catch(() => {
                                fallbackCopyToClipboard(urlToCopy);
                            });
                        } else {
                            fallbackCopyToClipboard(urlToCopy);
                        }
                    };
                }
            }
        }
        
        // í´ë¦½ë³´ë“œ ë³µì‚¬ fallback
        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                alert('URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. Safarië‚˜ Chromeì—ì„œ ë¶™ì—¬ë„£ê¸°í•˜ì—¬ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
            } catch (err) {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. URLì„ ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”: ' + text);
            } finally {
                document.body.removeChild(textArea);
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        window.onload = handleAppRedirect;
        
        // í˜ì´ì§€ ì–¸ë¡œë“œ ë°©ì§€ (ë¬´í•œ ë¦¬í”„ë ˆì‹œ ë°©ì§€)
        window.addEventListener('beforeunload', function(e) {
            console.log('í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œë„');
        });
    </script>
</head>
<body>
    <div style="text-align: center; padding: 50px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
        <h1>ğŸ´ ForkFork</h1>
        
        <div class="loading-message">
            <p>ì¹œêµ¬ ì¶”ê°€ ë§í¬ë¥¼ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</p>
            <div style="margin: 20px 0;">
                <div style="width: 30px; height: 30px; border: 2px solid #f3f3f3; border-top: 2px solid #007AFF; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
            </div>
        </div>
        
        <!-- ì¹´ì¹´ì˜¤í†¡ ì‚¬ìš©ìë¥¼ ìœ„í•œ ì•ˆë‚´ (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€) -->
        <div id="kakao-instructions" style="display: none; margin-top: 30px; padding: 20px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
            <h3>ğŸ”§ ì¹´ì¹´ì˜¤í†¡ì—ì„œ ì•± ì‹¤í–‰ ì•ˆë‚´</h3>
            <p>ì¹´ì¹´ì˜¤í†¡ì—ì„œëŠ” ì•±ì´ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <p><strong>ë‹¤ìŒ ë°©ë²• ì¤‘ í•˜ë‚˜ë¥¼ ì‹œë„í•´ì£¼ì„¸ìš”:</strong></p>
            <ol style="text-align: left; max-width: 300px; margin: 0 auto;">
                <li><strong>ì˜¤ë¥¸ìª½ ìƒë‹¨ ì  3ê°œ</strong> â†’ <strong>Safariì—ì„œ ì—´ê¸°</strong></li>
                <li>ì•„ë˜ <strong>URL ë³µì‚¬</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ Safariì—ì„œ ì‹¤í–‰</li>
                <li>ê·¸ë˜ë„ ì•ˆ ë˜ë©´ <strong>App Store</strong>ì—ì„œ ì•±ì„ ë‹¤ìš´ë¡œë“œ</li>
            </ol>
            <br>
            <button id="copy-url-btn" style="background-color: #007AFF; color: white; padding: 10px 20px; border: none; border-radius: 6px; font-weight: bold; margin: 5px;">
                ğŸ“‹ URL ë³µì‚¬í•˜ê¸°
            </button>
        </div>
        
        <br><br>
        <p>ì•±ì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•Šë‹¤ë©´, ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.</p>
        <br>
        <a href="https://apps.apple.com/kr/app/forkfork/id6744844399?l=en-GB" 
           style="display: inline-block; background-color: #007AFF; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; font-weight: bold;">
            App Storeì—ì„œ ë‹¤ìš´ë¡œë“œ
        </a>
    </div>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html> 
