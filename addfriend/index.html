<!DOCTYPE html>
<html>
<head>
    <title>ForkFork - Add Friend</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Smart App Banner for better iOS app detection -->
    <meta name="apple-itunes-app" content="app-id=6744844399">
    
    <!-- Prevent caching to ensure fresh content -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- Open Graph tags for better sharing -->
    <meta property="og:title" content="ForkFork - 친구 추가">
    <meta property="og:description" content="ForkFork 앱에서 새로운 친구를 추가하세요!">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://forkfork-official.github.io/addfriend">
    
    <!-- Additional iOS compatibility -->
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <script>
        // 무한 루프 방지를 위한 상태 관리
        const STORAGE_KEY = 'forkfork_redirect_attempt';
        const MAX_ATTEMPTS = 2;
        
        // 카카오톡 인앱 브라우저 감지
        function isKakaoTalkInApp() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            return userAgent.toLowerCase().includes('kakaotalk');
        }
        
        // 실행 시도 횟수 체크 및 업데이트
        function checkAndUpdateAttempts(deviceID) {
            const key = `${STORAGE_KEY}_${deviceID}`;
            const attempts = parseInt(localStorage.getItem(key) || '0');
            
            if (attempts >= MAX_ATTEMPTS) {
                console.log('최대 시도 횟수 초과, 안내 표시');
                return false;
            }
            
            localStorage.setItem(key, (attempts + 1).toString());
            
            // 10초 후 카운터 리셋 (성공적으로 앱이 실행된 경우를 위해)
            setTimeout(() => {
                localStorage.removeItem(key);
            }, 10000);
            
            return true;
        }
        
        // 안전한 앱 실행 시도
        function attemptAppLaunch(deviceID) {
            return new Promise((resolve, reject) => {
                let hasRedirected = false;
                let timeoutId = null;
                let visibilityHandler = null;
                
                // 정리 함수
                const cleanup = () => {
                    if (timeoutId) {
                        clearTimeout(timeoutId);
                        timeoutId = null;
                    }
                    if (visibilityHandler) {
                        document.removeEventListener('visibilitychange', visibilityHandler);
                        document.removeEventListener('pagehide', visibilityHandler);
                        visibilityHandler = null;
                    }
                };
                
                // 타이머 설정
                timeoutId = setTimeout(() => {
                    if (!hasRedirected) {
                        hasRedirected = true;
                        cleanup();
                        reject(new Error('App launch failed'));
                    }
                }, 2500);
                
                // 페이지 가시성 변화 감지
                visibilityHandler = () => {
                    if ((document.hidden || document.visibilityState === 'hidden') && !hasRedirected) {
                        hasRedirected = true;
                        cleanup();
                        resolve();
                    }
                };
                
                document.addEventListener('visibilitychange', visibilityHandler);
                document.addEventListener('pagehide', visibilityHandler);
                
                // 앱 실행 시도 (무한 루프 방지)
                try {
                    console.log('앱 실행 시도:', deviceID);
                    
                    // 방법 1: iframe을 통한 커스텀 URL 스킴
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.style.width = '1px';
                    iframe.style.height = '1px';
                    iframe.src = `forkfork://addfriend?deviceID=${deviceID}`;
                    document.body.appendChild(iframe);
                    
                    // iframe 정리
                    setTimeout(() => {
                        if (iframe.parentNode) {
                            iframe.parentNode.removeChild(iframe);
                        }
                    }, 1000);
                    
                } catch (error) {
                    console.log('App launch attempt failed:', error);
                    hasRedirected = true;
                    cleanup();
                    reject(error);
                }
            });
        }
        
        // 메인 처리 함수
        function handleAppRedirect() {
            // URL parameters 파싱
            const urlParams = new URLSearchParams(window.location.search);
            const deviceID = urlParams.get('deviceID');
            
            if (!deviceID) {
                console.log('deviceID가 없어 앱스토어로 이동');
                window.location.href = "https://apps.apple.com/kr/app/forkfork/id6744844399?l=en-GB";
                return;
            }
            
            // 무한 루프 방지 체크
            if (!checkAndUpdateAttempts(deviceID)) {
                console.log('최대 시도 횟수 초과');
                showKakaoInstructions(deviceID);
                return;
            }
            
            console.log('친구 추가 처리 시작:', deviceID);
            
            // 카카오톡 인앱 브라우저 특별 처리
            if (isKakaoTalkInApp()) {
                console.log('카카오톡 인앱 브라우저에서 실행됨');
                handleKakaoInApp(deviceID);
                return;
            }
            
            // 일반 브라우저 처리
            handleNormalBrowser(deviceID);
        }
        
        // 카카오톡 인앱 브라우저 처리
        function handleKakaoInApp(deviceID) {
            // 즉시 안내 표시 (앱 실행 시도 없이)
            showKakaoInstructions(deviceID);
        }
        
        // 일반 브라우저 처리
        function handleNormalBrowser(deviceID) {
            let hasRedirected = false;
            
            attemptAppLaunch(deviceID)
                .then(() => {
                    hasRedirected = true;
                    console.log('앱 실행 성공');
                    // 성공 시 시도 카운터 리셋
                    localStorage.removeItem(`${STORAGE_KEY}_${deviceID}`);
                })
                .catch(() => {
                    if (!hasRedirected) {
                        hasRedirected = true;
                        console.log('앱 실행 실패 - 앱스토어로 이동');
                        // 약간의 지연 후 앱스토어로 이동 (사용자가 상황을 인지할 수 있도록)
                        setTimeout(() => {
                            window.location.href = "https://apps.apple.com/kr/app/forkfork/id6744844399?l=en-GB";
                        }, 500);
                    }
                });
        }
        
        // 카카오톡 사용자를 위한 안내 표시
        function showKakaoInstructions(deviceID) {
            // 로딩 메시지 숨기기
            const loadingMsg = document.querySelector('.loading-message');
            if (loadingMsg) {
                loadingMsg.style.display = 'none';
            }
            
            const instructionDiv = document.getElementById('kakao-instructions');
            if (instructionDiv) {
                instructionDiv.style.display = 'block';
                
                // URL 복사 기능
                const copyButton = document.getElementById('copy-url-btn');
                if (copyButton) {
                    copyButton.onclick = () => {
                        const urlToCopy = `https://forkfork-official.github.io/addfriend?deviceID=${deviceID}`;
                        
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            navigator.clipboard.writeText(urlToCopy).then(() => {
                                alert('URL이 복사되었습니다. Safari나 Chrome에서 붙여넣기하여 실행해주세요.');
                            }).catch(() => {
                                fallbackCopy(urlToCopy);
                            });
                        } else {
                            fallbackCopy(urlToCopy);
                        }
                    };
                }
                
                // 외부 브라우저 열기 버튼
                const openExternalButton = document.getElementById('open-external-btn');
                if (openExternalButton) {
                    openExternalButton.onclick = () => {
                        const externalUrl = `https://forkfork-official.github.io/addfriend/external-redirect.html?deviceID=${deviceID}`;
                        window.location.href = externalUrl;
                    };
                }
            }
        }
        
        // 복사 fallback 함수
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                alert('URL이 복사되었습니다. Safari나 Chrome에서 붙여넣기하여 실행해주세요.');
            } catch (err) {
                alert('복사에 실패했습니다. URL을 수동으로 복사해주세요: ' + text);
            }
            
            document.body.removeChild(textArea);
        }
        
        // 페이지 로드 시 실행
        window.onload = handleAppRedirect;
        
        // 페이지 focus 시 시도 카운터 리셋 (사용자가 다시 돌아온 경우)
        window.onfocus = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const deviceID = urlParams.get('deviceID');
            if (deviceID) {
                // 포커스 시 카운터 리셋 (단, 즉시가 아닌 조금 후에)
                setTimeout(() => {
                    localStorage.removeItem(`${STORAGE_KEY}_${deviceID}`);
                }, 1000);
            }
        };
    </script>
</head>
<body>
    <div style="text-align: center; padding: 50px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
        <h1>🍴 ForkFork</h1>
        <p>친구 추가 링크를 처리 중입니다...</p>
        
        <!-- 카카오톡 사용자를 위한 안내 (기본적으로 숨김) -->
        <div id="kakao-instructions" style="display: none; margin-top: 30px; padding: 20px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
            <h3>🔧 카카오톡에서 앱 실행 안내</h3>
            <p>카카오톡에서는 앱이 자동으로 실행되지 않을 수 있습니다.</p>
            <p><strong>다음 방법 중 하나를 시도해주세요:</strong></p>
            <ol style="text-align: left; max-width: 300px; margin: 0 auto;">
                <li><strong>오른쪽 상단 점 3개</strong> → <strong>Safari에서 열기</strong></li>
                <li>아래 <strong>URL 복사</strong> 버튼을 눌러 Safari에서 실행</li>
                <li>그래도 안 되면 <strong>App Store</strong>에서 앱을 다운로드</li>
            </ol>
            <br>
            <button id="copy-url-btn" style="background-color: #007AFF; color: white; padding: 10px 20px; border: none; border-radius: 6px; font-weight: bold; margin: 5px;">
                📋 URL 복사하기
            </button>
        </div>
        
        <br><br>
        <p>앱이 설치되어 있지 않다면, 아래 버튼을 눌러 다운로드하세요.</p>
        <br>
        <a href="https://apps.apple.com/kr/app/forkfork/id6744844399?l=en-GB" 
           style="display: inline-block; background-color: #007AFF; color: white; padding: 12px 24px; text-decoration: none; border-radius: 8px; font-weight: bold;">
            App Store에서 다운로드
        </a>
    </div>
</body>
</html> 
